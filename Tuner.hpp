#ifndef _TUNER_H_
#define _TUNER_H_

#include <Arduino.h>

const int NOTE_BUFFER = 3;

struct cFreq4
{
  // the four frequencies of the range (in Hz*10)
  uint16_t mLowest, mLow, mHigh, mHighest;
  char mNote[NOTE_BUFFER]; // C C# D D# E F F# G G# A A# B
  char mOctave;           // number of the octave eg 440 is A 4.
};

static const cFreq4 sgNotes[] PROGMEM =
    {
        {159, 162, 164, 167, "C", 0},      //    16.352 Hz
        {168, 172, 174, 177, "C#", 0},     //    17.324 Hz
        {178, 182, 184, 188, "D", 0},      //    18.354 Hz
        {189, 193, 195, 199, "D#", 0},     //    19.445 Hz
        {200, 204, 207, 211, "E", 0},      //    20.602 Hz
        {212, 216, 219, 224, "F", 0},      //    21.827 Hz
        {225, 229, 232, 237, "F#", 0},     //    23.125 Hz
        {238, 243, 246, 251, "G", 0},      //    24.500 Hz
        {252, 257, 261, 266, "G#", 0},     //    25.957 Hz
        {267, 272, 277, 282, "A", 0},      //    27.500 Hz
        {283, 289, 293, 299, "A#", 0},     //    29.135 Hz
        {300, 306, 311, 317, "B", 0},      //    30.868 Hz
        {318, 324, 329, 336, "C", 1},      //    32.703 Hz
        {337, 343, 349, 356, "C#", 1},     //    34.648 Hz
        {357, 364, 370, 377, "D", 1},      //    36.708 Hz
        {378, 385, 392, 399, "D#", 1},     //    38.891 Hz
        {400, 408, 415, 423, "E", 1},      //    41.203 Hz
        {424, 432, 440, 448, "F", 1},      //    43.654 Hz
        {449, 458, 466, 475, "F#", 1},     //    46.249 Hz
        {476, 485, 494, 503, "G", 1},      //    48.999 Hz
        {504, 514, 523, 533, "G#", 1},     //    51.913 Hz
        {534, 545, 554, 565, "A", 1},      //    55.000 Hz
        {566, 577, 587, 599, "A#", 1},     //    58.270 Hz
        {600, 611, 622, 634, "B", 1},      //    61.735 Hz
        {635, 648, 659, 672, "C", 2},      //    65.406 Hz
        {673, 686, 699, 712, "C#", 2},     //    69.296 Hz
        {713, 727, 740, 755, "D", 2},      //    73.416 Hz
        {756, 770, 784, 800, "D#", 2},     //    77.782 Hz
        {801, 816, 831, 847, "E", 2},      //    82.407 Hz
        {848, 865, 881, 898, "F", 2},      //    87.307 Hz
        {899, 916, 933, 951, "F#", 2},     //    92.499 Hz
        {952, 971, 988, 1008, "G", 2},     //    97.999 Hz
        {1009, 1028, 1047, 1068, "G#", 2}, //   103.826 Hz
        {1069, 1089, 1110, 1131, "A", 2},  //   110.000 Hz
        {1132, 1154, 1176, 1199, "A#", 2}, //   116.541 Hz
        {1200, 1223, 1246, 1270, "B", 2},  //   123.471 Hz
        {1271, 1296, 1320, 1345, "C", 3},  //   130.813 Hz
        {1346, 1373, 1398, 1426, "C#", 3}, //   138.591 Hz
        {1427, 1454, 1482, 1510, "D", 3},  //   146.832 Hz
        {1511, 1541, 1570, 1600, "D#", 3}, //   155.563 Hz
        {1601, 1632, 1663, 1695, "E", 3},  //   164.814 Hz
        {1696, 1729, 1762, 1796, "F", 3},  //   174.614 Hz
        {1797, 1832, 1867, 1903, "F#", 3}, //   184.997 Hz
        {1904, 1941, 1978, 2016, "G", 3},  //   195.998 Hz
        {2017, 2057, 2096, 2136, "G#", 3}, //   207.652 Hz
        {2137, 2179, 2220, 2263, "A", 3},  //   220.000 Hz
        {2264, 2308, 2352, 2398, "A#", 3}, //   233.082 Hz
        {2399, 2446, 2492, 2541, "B", 3},  //   246.942 Hz
        {2542, 2591, 2641, 2692, "C", 4},  //   261.626 Hz
        {2693, 2745, 2798, 2852, "C#", 4}, //   277.183 Hz
        {2853, 2909, 2964, 3022, "D", 4},  //   293.665 Hz
        {3023, 3081, 3140, 3201, "D#", 4}, //   311.127 Hz
        {3202, 3265, 3327, 3392, "E", 4},  //   329.628 Hz
        {3393, 3459, 3525, 3594, "F", 4},  //   349.228 Hz
        {3595, 3664, 3735, 3807, "F#", 4}, //   369.994 Hz
        {3808, 3882, 3957, 4034, "G", 4},  //   391.995 Hz
        {4035, 4113, 4192, 4274, "G#", 4}, //   415.305 Hz
        {4275, 4358, 4442, 4528, "A", 4},  //   440.000 Hz
        {4529, 4617, 4706, 4797, "A#", 4}, //   466.164 Hz
        {4798, 4892, 4986, 5083, "B", 4},  //   493.883 Hz
        {5084, 5182, 5282, 5385, "C", 5},  //   523.251 Hz
        {5386, 5491, 5596, 5705, "C#", 5}, //   554.365 Hz
        {5706, 5817, 5929, 6044, "D", 5},  //   587.330 Hz
        {6045, 6163, 6282, 6404, "D#", 5}, //   622.254 Hz
        {6405, 6529, 6655, 6785, "E", 5},  //   659.255 Hz
        {6786, 6918, 7051, 7188, "F", 5},  //   698.456 Hz
        {7189, 7329, 7470, 7616, "F#", 5}, //   739.989 Hz
        {7617, 7765, 7915, 8069, "G", 5},  //   783.991 Hz
        {8070, 8227, 8385, 8548, "G#", 5}, //   830.609 Hz
        {8549, 8716, 8884, 9057, "A", 5},  //   880.000 Hz
        {9058, 9234, 9412, 9595, "A#", 5}, //   932.328 Hz
        {9596, 9783, 9972, 10166, "B", 5}, //   987.767 Hz
#if 0 // frqeuncy determination code cannot handle this high a frequency ?
        {10167, 10365, 10565, 10771, "C", 6},      //  1046.502 Hz
        {10772, 10981, 11194, 11411, "C#", 6},     //  1108.731 Hz
        {11412, 11634, 11859, 12090, "D", 6},      //  1174.659 Hz
        {12091, 12326, 12564, 12809, "D#", 6},     //  1244.508 Hz
        {12810, 13059, 13312, 13570, "E", 6},      //  1318.510 Hz
        {13571, 13835, 14103, 14377, "F", 6},      //  1396.913 Hz
        {14378, 14658, 14942, 15232, "F#", 6},     //  1479.978 Hz
        {15233, 15530, 15830, 16138, "G", 6},      //  1567.982 Hz
        {16139, 16453, 16772, 17098, "G#", 6},     //  1661.219 Hz
        {17099, 17431, 17769, 18115, "A", 6},      //  1760.000 Hz
        {18116, 18468, 18826, 19192, "A#", 6},     //  1864.655 Hz
        {19193, 19566, 19945, 20333, "B", 6},      //  1975.533 Hz
        {20334, 20730, 21132, 21542, "C", 7},      //  2093.005 Hz
        {21543, 21962, 22388, 22823, "C#", 7},     //  2217.461 Hz
        {22824, 23268, 23719, 24181, "D", 7},      //  2349.318 Hz
        {24182, 24652, 25130, 25618, "D#", 7},     //  2489.016 Hz
        {25619, 26118, 26624, 27142, "E", 7},      //  2637.020 Hz
        {27143, 27671, 28208, 28756, "F", 7},      //  2793.826 Hz
        {28757, 29316, 29885, 30466, "F#", 7},     //  2959.955 Hz
        {30467, 31059, 31662, 32278, "G", 7},      //  3135.963 Hz
        {32279, 32906, 33545, 34197, "G#", 7},     //  3322.438 Hz
        {34198, 34863, 35540, 36230, "A", 7},      //  3520.000 Hz
        {36231, 36936, 37653, 38385, "A#", 7},     //  3729.310 Hz
        {38386, 39132, 39892, 40667, "B", 7},      //  3951.066 Hz
        {40668, 41459, 42264, 43086, "C", 8},      //  4186.009 Hz
        {43087, 43924, 44777, 45648, "C#", 8},     //  4434.922 Hz
        {45649, 46536, 47440, 48362, "D", 8},      //  4698.636 Hz
        {48363, 49303, 50261, 51238, "D#", 8},     //  4978.032 Hz
        {51239, 52235, 53250, 54285, "E", 8},      //  5274.041 Hz
        {54286, 55341, 56416, 57513, "F", 8},      //  5587.652 Hz
        {57514, 58632, 59771, 60933, "F#", 8},     //  5919.911 Hz
        {60934, 62118, 63325, 64556, "G", 8},      //  6271.927 Hz
        // uint16_t => overflow !
        {64557, 65812, 67091, 68395, "G#", 8},     //  6644.875 Hz
        {68396, 69726, 71080, 72462, "A", 8},      //  7040.000 Hz
        {72463, 73872, 75307, 76771, "A#", 8},     //  7458.620 Hz
        {76772, 78264, 79785, 81336, "B", 8},      //  7902.133 Hz
        {81337, 82918, 84529, 86172, "C", 9},      //  8372.018 Hz
        {86173, 87849, 89555, 91297, "C#", 9},     //  8869.844 Hz
        {91298, 93072, 94881, 96725, "D", 9},      //  9397.273 Hz
        {96726, 98607, 100523, 102477, "D#", 9},   //  9956.063 Hz
        {102478, 104470, 106500, 108571, "E", 9},  // 10548.082 Hz
        {108572, 110682, 112833, 115027, "F", 9},  // 11175.303 Hz
        {115028, 117264, 119543, 121867, "F#", 9}, // 11839.822 Hz
        {121868, 124237, 126651, 129113, "G", 9},  // 12543.854 Hz
        {129114, 131624, 134182, 136791, "G#", 9}, // 13289.750 Hz
        {136792, 139451, 142161, 144925, "A", 9},  // 14080.000 Hz
        {144926, 147743, 150614, 153542, "A#", 9}, // 14917.240 Hz
        {153543, 156528, 159570, 162673, "B", 9},  // 15804.266 Hz
#endif
};

struct Match
{
  int Frequency;
  char Note[NOTE_BUFFER];
  char Octave;
  bool OutOfRange;
  bool IsSharp;
  bool IsFlat;
};

class Tuner
{
  const int sgNoteCount = sizeof sgNotes / sizeof sgNotes[0];
  uint16_t sgLowestFrequency;
  uint16_t sgHighestFrequency;

public:
  Tuner();
  Match CalculateNote(int frequency);
};

#endif // _TUNER_H_